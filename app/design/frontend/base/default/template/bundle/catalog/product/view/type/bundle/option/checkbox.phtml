<?php
/**
 * Magento Enterprise Edition
 *
 * NOTICE OF LICENSE
 *
 * This source file is subject to the Magento Enterprise Edition End User License Agreement
 * that is bundled with this package in the file LICENSE_EE.txt.
 * It is also available through the world-wide-web at this URL:
 * http://www.magento.com/license/enterprise-edition
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@magento.com so we can send you a copy immediately.
 *
 * DISCLAIMER
 *
 * Do not edit or add to this file if you wish to upgrade Magento to newer
 * versions in the future. If you wish to customize Magento for your
 * needs please refer to http://www.magento.com for more information.
 *
 * @category    design
 * @package     base_default
 * @copyright Copyright (c) 2006-2017 X.commerce, Inc. and affiliates (http://www.magento.com)
 * @license http://www.magento.com/license/enterprise-edition
 */

?><?php 
/* @var $this Mage_Bundle_Block_Catalog_Product_View_Type_Bundle_Option_Checkbox
 *
 */ ?><?php
/**
 * rmorales@mlg.com.mx
 * view_products
 * 
 */

$view_products = true;

?><?php 
$_option = $this->getOption(); ?><?php 
$_selections = $_option->getSelections();

$n_selections = count( $_selections );

$_product = $this->getProduct();
$_opc_config = null;

if( isset( $_product->_data['more_data'] ) ){
	//echo '<pre style="display:none;">'.$_product->_data['more_data'].'</pre>';
	$_opc_config = json_decode( $_product->_data['more_data'], true );
	//echo '<pre style="display:none;">'.print_r( $_opc_config, true ).'</pre>';
}

// detecta configurable_max_prods para los paquetes con opcion checkbox
$select_product = 0;

	if( isset( $_product->_data['configurable_max_prods'] ) ){
		$select_product = $_product->_data['configurable_max_prods'];
		?><!-- configurable_max_prods <?php echo $select_product; ?> --><?php
	}

	if( $select_product>0 ){
		//if( $n_selections<$select_product ){ $view_products = false; }
	}

?>

<!-- product_checkbox -->
<dt><label<?php if ($_option->getRequired()) echo ' class="required"' ?>><?php echo $this->escapeHtml($_option->getTitle()) ?><?php if ($_option->getRequired()) echo '<em>*</em>' ?></label></dt>
<dd<?php if ($_option->decoratedIsLast){?> class="last"<?php }?>>
    <div class="input-box"><?php 
    //if (count($_selections) == 1 && $_option->getRequired()): ?><?php 
    	//echo $this->getSelectionQtyTitlePrice($_selections[0]) ?><?php 
        // echo '<input type="hidden" name="bundle_option['.$_option->getId().']" value="'.( $_selections[0]->getSelectionId() ).'"/>'; ?><?php 
    //else:?>
    	<!-- listado_de_productos <?php echo $n_selections; ?> --><?php
    	if( $view_products ){
    		?><ul class="options-list group_edit">
	        <?php foreach($_selections as $_selection): ?>
	            <li>
					<div class="label">
						<div class="cell col1">
							<img class="thumbnail" 
							src="<?php echo $this->helper('catalog/image')->init($_selection, 'thumbnail')->constrainOnly(true)->resize(105, 80); ?>"
							alt="<?php echo $this->escapeHtml($this->getImageLabel()) ?>"
							title="<?php echo $this->escapeHtml($this->getImageLabel()); ?>" />
						</div>
						<div class="cell col2">
							<input onclick="bundle.changeSelection(this)" <?php
								?> class="change-container-classname checkbox bundle-option-<?php echo $_option->getId() ?> <?php if ($_option->getRequired()) echo 'validate-one-required-by-name' ?>" <?php
								?> id="bundle-option-<?php echo $_option->getId() ?>-<?php echo $_selection->getSelectionId() ?>" <?php
								?> type="checkbox" <?php
								?> name="bundle_option[<?php echo $_option->getId() ?>][]"<?php if ($this->_isSelected($_selection)) echo ' checked="checked"' ?><?php if (!$_selection->isSaleable()) echo ' disabled="disabled"' ?> <?php
								?> value="<?php echo $_selection->getSelectionId() ?>"/>
							<label for="bundle-option-<?php echo $_option->getId() ?>-<?php echo $_selection->getSelectionId() ?>"><?php 
								$title_alt = false;

								if( isset( $_opc_config['products_group'] ) ){
									$idsp =  $_selection->getId();
									$ssku = Mage::getModel('catalog/product')->load( $idsp )->getSku();
									if( $ssku ){
										if( isset( $_opc_config['products_group'][ $ssku ] ) ){
											if( isset( $_opc_config['products_group'][ $ssku ]['title'] ) ){
												echo $_opc_config['products_group'][ $ssku ]['title'];
												if( isset( $_opc_config['products_group'][ $ssku ]['subtitle'] ) ){
													echo '<br>'.'<span>'.$_opc_config['products_group'][ $ssku ]['subtitle'].'</span>';
												}
												$title_alt = true;
											}
										}
									}
								}

								echo '</span>';

								if( !$title_alt ){
									echo $this->getSelectionQtyTitlePrice($_selection);
								}
								
								?></label>
						</div>
					</div><?php
					if($_option->getRequired()): ?>
	                    <?php echo $this->setValidationContainer('bundle-option-'.$_option->getId().'-'.$_selection->getSelectionId(), 'bundle-option-'.$_option->getId().'-container') ?>
	                <?php endif; ?>
	            </li>
	        <?php endforeach; ?>
	    	</ul><?php
		} ?>
        <div id="bundle-option-<?php echo $_option->getId() ?>-container"></div>
    <?php //endif; ?>
    </div>
</dd>
