<?php
/**
 * Magento Enterprise Edition
 *
 * NOTICE OF LICENSE
 *
 * This source file is subject to the Magento Enterprise Edition End User License Agreement
 * that is bundled with this package in the file LICENSE_EE.txt.
 * It is also available through the world-wide-web at this URL:
 * http://www.magento.com/license/enterprise-edition
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@magento.com so we can send you a copy immediately.
 *
 * DISCLAIMER
 *
 * Do not edit or add to this file if you wish to upgrade Magento to newer
 * versions in the future. If you wish to customize Magento for your
 * needs please refer to http://www.magento.com for more information.
 *
 * @category    design
 * @package     base_default
 * @copyright Copyright (c) 2006-2017 X.commerce, Inc. and affiliates (http://www.magento.com)
 * @license http://www.magento.com/license/enterprise-edition
 */

?>

<?php /* @var $this Mage_Bundle_Block_Catalog_Product_View_Type_Bundle_Option_Checkbox */ ?><?php 
$_option = $this->getOption(); ?><?php 
$_selections = $_option->getSelections(); ?><?php

$_product = $this->getProduct();
$_opc_config = null;

if( isset( $_product->_data['more_data'] ) ){
	echo '<pre style="display:none;">'.$_product->_data['more_data'].'</pre>';
	$_opc_config = json_decode( $_product->_data['more_data'], true );
	echo '<pre style="display:none;">'.print_r( $_opc_config, true ).'</pre>';
}

?>

<dt><label<?php if ($_option->getRequired()) echo ' class="required"' ?>><?php echo $this->escapeHtml($_option->getTitle()) ?><?php if ($_option->getRequired()) echo '<em>*</em>' ?></label></dt>
<dd<?php if ($_option->decoratedIsLast){?> class="last"<?php }?>>
    <div class="input-box">
    <?php if (count($_selections) == 1 && $_option->getRequired()): ?>
        <?php echo $this->getSelectionQtyTitlePrice($_selections[0]) ?>
        <input type="hidden" name="bundle_option[<?php echo $_option->getId() ?>]" value="<?php echo $_selections[0]->getSelectionId() ?>"/>
    <?php else:?>
        <ul class="options-list group_edit">
        <?php foreach($_selections as $_selection): ?>
            <li>
            	<pre style="display: none"><?php print_r( $_selection ); ?></pre>
				<div class="label">
					<div class="cell col1">
						<img class="thumbnail" 
						src="<?php echo $this->helper('catalog/image')->init($_selection, 'thumbnail')->constrainOnly(true)->resize(105, 80); ?>"
						alt="<?php echo $this->escapeHtml($this->getImageLabel()) ?>"
						title="<?php echo $this->escapeHtml($this->getImageLabel()); ?>" />
					</div>
					<div class="cell col2">
						<input onclick="bundle.changeSelection(this)" 
							class="change-container-classname checkbox bundle-option-<?php echo $_option->getId() ?> <?php if ($_option->getRequired()) echo 'validate-one-required-by-name' ?>" 
							id="bundle-option-<?php echo $_option->getId() ?>-<?php echo $_selection->getSelectionId() ?>" 
							type="checkbox" 
							name="bundle_option[<?php echo $_option->getId() ?>][]"<?php if ($this->_isSelected($_selection)) echo ' checked="checked"' ?><?php if (!$_selection->isSaleable()) echo ' disabled="disabled"' ?> 
							value="<?php echo $_selection->getSelectionId() ?>"/>
						<label for="bundle-option-<?php echo $_option->getId() ?>-<?php echo $_selection->getSelectionId() ?>"><?php 
							$title_alt = false;

							if( isset( $_opc_config['products_group'] ) ){
								$idsp =  $_selection->getId();
								$ssku = Mage::getModel('catalog/product')->load( $idsp )->getSku();
								if( $ssku ){
									if( isset( $_opc_config['products_group'][ $ssku ] ) ){
										if( isset( $_opc_config['products_group'][ $ssku ]['title'] ) ){
											echo $_opc_config['products_group'][ $ssku ]['title'];
											if( isset( $_opc_config['products_group'][ $ssku ]['subtitle'] ) ){
												echo '<br>'.'<span>'.$_opc_config['products_group'][ $ssku ]['subtitle'].'</span>';
											}
											$title_alt = true;
										}
									}
								}
							}

							/*
							echo '<span style="display:none;">';
							//echo $_selection->_data['entity_id'];
							$idsp =  $_selection->getId();
							$ssku = Mage::getModel('catalog/product')->load( $idsp )->getSku();
							if( $ssku ){
								echo $ssku;
							}
							/*
							if( isset( $_opc_config['products_group'] ) ){
								$title_alt = false;
								foreach ( $_opc_config['products_group'] as $et => $r) {
									echo "p1 codigo_barras -- ";
									if( isset( $_product->_data['codigo_barras'] ) ){
										echo "p2 $et -- ".$_product->_data['codigo_barras'].' -- ';
										if( $et == $_product->_data['codigo_barras'] ){
											echo "p3 title -- ";
											if( isset( $r['title'] ) ){
												echo "p4 ".$r['title'];
												echo $r['title'];
												if( isset( $r['subtitle'] ) ){
													echo '<br>'.'<span>'.$r['subtitle'].'</span>';
												}
												$title_alt = true;
											}
										}
									}
								}
							}*/
							echo '</span>';

							if( !$title_alt ){
								echo $this->getSelectionQtyTitlePrice($_selection);
							}
							
						?></label>
					</div>
				</div>
                
				<!-- <span class="label">
					<img class="thumbnail" 
						src="<?php echo $this->helper('catalog/image')->init($_selection, 'thumbnail')->constrainOnly(true)->resize(105, 80); ?>"
						alt="<?php echo $this->escapeHtml($this->getImageLabel()) ?>"
						title="<?php echo $this->escapeHtml($this->getImageLabel()); ?>" />
					<input onclick="bundle.changeSelection(this)" class="change-container-classname checkbox bundle-option-<?php echo $_option->getId() ?> <?php if ($_option->getRequired()) echo 'validate-one-required-by-name' ?>" id="bundle-option-<?php echo $_option->getId() ?>-<?php echo $_selection->getSelectionId() ?>" type="checkbox" name="bundle_option[<?php echo $_option->getId() ?>][]"<?php if ($this->_isSelected($_selection)) echo ' checked="checked"' ?><?php if (!$_selection->isSaleable()) echo ' disabled="disabled"' ?> value="<?php echo $_selection->getSelectionId() ?>"/>
					<label for="bundle-option-<?php echo $_option->getId() ?>-<?php echo $_selection->getSelectionId() ?>">
						<?php echo $this->getSelectionQtyTitlePrice($_selection) ?>
					</label>
				</span> -->
                <?php if($_option->getRequired()): ?>
                    <?php echo $this->setValidationContainer('bundle-option-'.$_option->getId().'-'.$_selection->getSelectionId(), 'bundle-option-'.$_option->getId().'-container') ?>
                <?php endif; ?>
            </li>
        <?php endforeach; ?>
        </ul>
        <div id="bundle-option-<?php echo $_option->getId() ?>-container"></div>
    <?php endif; ?>
    </div>
</dd>
