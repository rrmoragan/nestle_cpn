<?php
/**
 * Magento Enterprise Edition
 *
 * NOTICE OF LICENSE
 *
 * This source file is subject to the Magento Enterprise Edition End User License Agreement
 * that is bundled with this package in the file LICENSE_EE.txt.
 * It is also available through the world-wide-web at this URL:
 * http://www.magento.com/license/enterprise-edition
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@magento.com so we can send you a copy immediately.
 *
 * DISCLAIMER
 *
 * Do not edit or add to this file if you wish to upgrade Magento to newer
 * versions in the future. If you wish to customize Magento for your
 * needs please refer to http://www.magento.com for more information.
 *
 * @category	design
 * @package		rwd_default
 * @copyright Copyright (c) 2006-2017 X.commerce, Inc. and affiliates (http://www.magento.com)
 * @license http://www.magento.com/license/enterprise-edition
 */
?>
<?php
/**
 * Shopping cart template
 *
 * @var $this Mage_Checkout_Block_Cart
 */
$order = ["Maquinas","Insumos","Accesorios","Nature's heart","Aguas","Consumibles"];
$categories = [];
$coffesolutions = Mage::getBlockSingleton('coffeesolutions/solutions_details');

/* modif rmorales@mlg.com.mx */
$ppd=[];

foreach($this->getItems() as $_item){

	$productGroupId = $_item->getProduct()->getAttributeSetId();
	$key = $coffesolutions->getAttributeSetNameById($productGroupId);

	if( !isset($categories[$key]["qty"]) ){ $categories[$key]["qty"] = 0; }
	if( !isset($categories[$key]["totalPrice"]) ){ $categories[$key]["totalPrice"] = 0; }

	$categories[$key]["items"][] = $_item;
	$categories[$key]["qty"] = $categories[$key]["qty"] + $_item->getQty(); 
	$categories[$key]["totalPrice"] = $categories[$key]["totalPrice"] + ($_item->getPrice() * $_item->getQty());

	/* modif rmorales@mlg.com.mx */

	$ppda=null;
	$ppda['key']=$key;
	$ppda['qty']=$categories[$key]["qty"];
	$ppda['priceb']=$_item->getPrice();	// precio por articulo
	$ppda['pricec']=$_item->getQty();	// numero de articulos
	$ppda['priced']=($_item->getPrice() * $_item->getQty());	// precio por el numero de articulos
	$ppd[]=$ppda;
}

?><?php
/*** clientes AAA
 * rmorales@mlg.com.mx
 * accesPaymentMethod
 */

$accesPaymentMethod = true;
	$is_user_aaa = false;

	$group_id = Mage::getSingleton('customer/session')->getCustomerGroupId();
	$group = Mage::getModel('customer/group')->load($group_id);
	if( $group->getCode() == 'Clientes AAA' ){
		$is_user_aaa = true;
	}

?><?php
/*** list all items
 * rmorales@mlg.com.mx
 * 
 */

	$all_items = null;

	foreach($this->getItems() as $_item){
		foreach ($_item->_data as $et => $r) {
			$ga_llp = null;
			$ga_llp['sku'] = $_item->_data['sku'];
			$ga_llp['name'] = $_item->_data['name'];
			$ga_llp['category'] = '';
			$ga_llp['marca'] = '';
			$ga_llp['qty'] = $_item->_data['qty'];
			$ga_llp['price'] = $_item->_data['price'];
			$all_items[ $_item->_data['sku'] ] = $ga_llp;
		}
	}

/*** list_all_products_ga
 * rmorales@mlg.com.mx
 * 
 */
	$goo_metricas = false;
	$ga_lp = $all_items;

/*** ver_boton_pagar_superior
 * rmorales@mlg.com.mx
 * 
 */
	$button_sup = 0;

/*** codigo_vendedor
 * rmorales@mlg.com.mx
 * 
 */
	/* si $is_code_vendor == true ==> significa que hay que agregar
	 * el formulario para agregar el codigo de vendedor */
	$is_code_vendor = true;
	$url_update = '/skin/frontend/base/default/mercadopago/images/loading.gif';

	$cvd = null;
	if( isset( $this->_quote->_data ) ){
		$cvd = array(
			'system'=> '',
			'quote_id'			=> $this->_quote->_data['entity_id'],
			'store_id'			=> $this->_quote->_data['store_id'],
			'created_at'		=> $this->_quote->_data['created_at'],
			'updated_at'		=> $this->_quote->_data['updated_at'],
			'items_count'		=> $this->_quote->_data['items_count'],
			'items_qty'			=> $this->_quote->_data['items_qty'],
			'grand_total'		=> $this->_quote->_data['grand_total'],
			'customer_id'		=> $this->_quote->_data['customer_id'],
			'customer_email'	=> $this->_quote->_data['customer_email'],
			'customer_firstname'=> $this->_quote->_data['customer_firstname'],
			'customer_lastname' => $this->_quote->_data['customer_lastname'],
			'remote_ip'		    => $this->_quote->_data['remote_ip'],
			'subtotal'			=> $this->_quote->_data['subtotal'],
			//'customer_openpay_user_id' => $this->_quote->_data['customer_openpay_user_id'],
			'customer_openpay_user_id' => '',
			'items'				=> $ga_lp,
			'code_vendor'		=> ''
		);
	}

?><?php
/*** message_delivery_time
 * rmorales@mlg.com.mx
 * 
 */

$message_delivery_time = true;

?><?php 
	$_priceDisplay = ($this->helper('tax')->displayCartBothPrices()) ? 'display-both-prices' : 'display-single-price'; ?>
<div class="cart <?php echo $_priceDisplay; ?>">
	<?php if( $button_sup ){ ?>
		<div class="page-title title-buttons">
			<h1><?php echo $this->__('Shopping Cart') ?></h1>
			<?php if(!$this->hasError()): ?>
			<ul class="checkout-types top">
			<?php foreach ($this->getMethods('top_methods') as $method): ?>
				<?php if ($methodHtml = $this->getMethodHtml($method)): ?>
				<li><?php echo $methodHtml; ?></li>
				<?php endif; ?>
			<?php endforeach; ?>
			</ul>
			<?php endif; ?>
		</div>
	<?php } ?>
	<?php echo $this->getMessagesBlock()->toHtml() ?>
	<?php echo $this->getChildHtml('form_before') ?>
<?php 
$size = count($categories);
$counter = 0;
foreach($order as $key ):
	if(!isset( $categories[$key]["items"] ) ) continue;	?>
	<form class="column-left" action="<?php echo $this->getFormActionUrl() ?>" method="post">
		<div class="tabs">
			<h2 class="tit_tab accordion"><?php echo $key ?>	<span class="<?php echo str_replace(" ", "", $key) ?>"></span></h2>
			<div class="cont_panel">
				<?php echo $this->getBlockHtml('formkey'); ?>
				<!-- shopping-cart-table_op_1 -->
				<table id="shopping-cart-table" class="cart-table data-table">
					<col width="1" />
					<col width="1" />
					<col width="1" />
					<col width="1" />
					<col width="1" />
					<?php if ($this->helper('tax')->displayCartBothPrices()): ?>
						<col width="1" />
						<col width="1" />
					<?php endif; ?>
					<?php $mergedCells = ($this->helper('tax')->displayCartBothPrices() ? 2 : 1); ?>
					<thead>
						<tr>
							<th rowspan="<?php echo $mergedCells; ?>"><span class="nobr"><?php echo $this->__('Product') ?></span></th>
							<th class="a-center cart-price-head" colspan="<?php echo $mergedCells; ?>">
								<!-- <div class="cart-price-placeholder">-->
									<span class="nobr"><?php echo $this->__('Price') ?></span>
								<!-- </div>-->
							</th>
							<th rowspan="<?php echo $mergedCells; ?>" class="a-center">
								<?php echo $this->__('Qty') ?>
								<?php /*if ($this->helper('wishlist')->isAllowInCart()) : ?>
									<span class="nobr"><?php echo $this->__('Move to Wishlist') ?></span>
								<?php endif*/ ?>
							</th>
							<th class="a-center cart-total-head" colspan="<?php echo $mergedCells; ?>">
								<!-- <div class="cart-total-placeholder"> -->
									<?php echo $this->__('Subtotal') ?>
								<!-- </div>-->
							</th>
							<th class="a-center" rowspan="<?php echo $mergedCells; ?>">&nbsp;</th>
						</tr>
						<?php if ($this->helper('tax')->displayCartBothPrices()): ?>
						<tr>
							<th class="a-center cart-price-head"><?php echo $this->helper('tax')->getIncExcTaxLabel(false) ?></th>
							<th class="a-center cart-price-head"><?php echo $this->helper('tax')->getIncExcTaxLabel(true) ?></th>
							<th class="a-center cart-total-head"><?php echo $this->helper('tax')->getIncExcTaxLabel(false) ?></th>
							<th class="a-center cart-total-head"><?php echo $this->helper('tax')->getIncExcTaxLabel(true) ?></th>
						</tr>
						<?php endif; ?>
					</thead>
					<tbody>
					<?php foreach($categories[$key]["items"] as $_item):?>
						<?php echo $this->getItemHtml($_item); ?>
					<?php endforeach ?>
					</tbody>
				</table>
			</div>
		</div>
		<?php 
		$counter++;
		if($size === $counter ): ?>
		<!-- shopping-cart-table_op_2 -->
		<table id="shopping-cart-table" class="cart-table data-table">
			<col width="1" />
			<col width="1" />
			<col width="1" />
			<col width="1" />
			<col width="1" />
			<?php if ($this->helper('tax')->displayCartBothPrices()): ?>
			<col width="1" />
			<col width="1" />
			<?php endif; ?>
			<tfoot>
				<tr>
					<td colspan="50" class="a-right cart-footer-actions">
						<div class="cont_button">
							<button type="submit" name="update_cart_action" data-cart-empty value="empty_cart" title="<?php echo $this->quoteEscape($this->__('Empty Cart')); ?>" class="button btn-empty" id="empty_cart_button"><span><span><?php echo $this->__('Empty Cart'); ?></span></span></button>
						</div>
						<div class="cont_button continue"><?php
							$__b = $urlHome = $this->getUrl('').'nuestros-productos.html';

							?><button type="button" <?php 
							?>title="<?php echo $this->quoteEscape($this->__('Continue Shopping')) ?>" <?php 
							?>class="button btn-continue" <?php 
							?>onclick="setLocation('<?php echo $__b; ?>')"><span><span><?php echo $this->__('Continue Shopping') ?></span></span></button> <?php 
							?><?php
								// if($this->getContinueShoppingUrl()){
									// <button type="button" title="\\<?php echo $this->quoteEscape($this->__('Continue Shopping')) ?\\>" class="button btn-continue" onclick="setLocation('<?php echo Mage::helper('core')->quoteEscape($this->getContinueShoppingUrl()) ?\\>')"><span><span><?php echo $this->__('Continue Shopping') ?\\></span></span></button>
								//}
						?></div>
					</td>
				</tr>
			</tfoot>
		</table>
		<?php endif; ?>
<?php endforeach; ?>
		</form>
		<?php echo $this->getChildHtml('shopping.cart.table.after'); ?>
	<div class="cart-forms">
		<div class="resume resume_sin_iva" <?php if( !$is_user_aaa ){ echo 'style="display:none;"'; } ?> >
			<h2 class="title_red"><?php echo $this->quoteEscape($this->__('Summary of your purchase')); ?></h2>
			<div class="sub">
				<h2 class="title_black"><?php echo $this->quoteEscape($this->__('Subtotal')); ?></h2>
					<table id="shopping-cart-totals-table">
							<colgroup><col>
							<col width="1">
							</colgroup>
							<tbody>
						<?php foreach($order as $key): ?> 
							<?php if(isset($categories[$key]["totalPrice"])): ?>
								<tr>
									<td style="" class="a-right">
										<span class="price" ><?php echo $this->helper('checkout')->formatPrice($categories[$key]["totalPrice"]) ?></span>	</td>
									<td class="title_resume" colspan="1">
										<?php echo $key ?><span class="<?php echo str_replace(" ", "", $key) ?>"></span></td>
								</tr>
							<?php endif; ?> 
						<?php endforeach?> 
						</tbody>
					</table>-
			</div>
			<div class="total">
				<h2 class="title_black"><?php echo $this->quoteEscape($this->__('Total de productos')); ?></h2>
			</div>
			<span class="price"><strong>
				<?php echo $this->helper('checkout')->formatPrice($this->getQuote()->getSubtotal()); ?>
			</strong></span>
			<?php //if (!$this->getIsVirtual()): echo $this->getChildHtml('shipping'); endif; ?>
		</div>
		<div class="resume grantotal" <?php if( $is_user_aaa ){ echo 'style="display:none;"'; } ?>>
			<?php echo $this->getChildHtml('totals'); ?>
		</div><?php

		// en clientes AAA se quita el aviso de tiempos de entregas
		if( $accesPaymentMethod ){
			if( $is_user_aaa == true ){
				$message_delivery_time = false;
			}
		}

		?><div style="display: none;"><pre><?php
			echo "\n accesPaymentMethod ==> "; if( $accesPaymentMethod ){ echo 'true'; }else{ echo 'false'; }
			echo "\n is_user_aaa ==> "; if( $is_user_aaa ){ echo 'true'; }else{ echo 'false'; }

		?></pre></div><?php

		if( $message_delivery_time ){
			?><div class="resume"><?php
			?><h2 class="title_black" style="text-transform:none;"><?php 
				echo $this->quoteEscape($this->__('Delivery time 72 hours'));
			?></h2></div><?php
		}

		?>
		<?php /* Extensions placeholder */ ?>
		<?php echo $this->getChildHtml('checkout_cart_widget') ?>
		<!-- envio_gratis --><?php
		$mlg_free_shipping = false;
		if( isset( $_SESSION['mlg']['mlg_free_shipping'] ) ){
			if( $_SESSION['mlg']['mlg_free_shipping'] == true ){
				?><div class="mlg_eg"><h2><?php echo $_SESSION['mlg']['mlg_message']; ?></h2></div><?php
			}
		}
		?><?php
		if($is_code_vendor){ ?><!-- vendor_code -->
			<form id="vendor_code">
				<div class="ccv">
					<h2>¿Tienes un código de vendedor?</h2>
					<div class="ccv_form">
						<div class="ccv_input" id="ccv_input"><?php 
						?><input <?php 
							?>type="text" <?php 
							?>name="vendor_code_data" <?php 
							?>id="vendor_code_data" <?php 
							?>class="input-text" <?php 
							?>value="" <?php 
							?>placeholder="Ingresa el código del vendedor"><?php 
						?></div>
						<div class="ccv_select" id="ccv_select" style="display: none;display: block;">
							<select id="vendor_code_data_select" class="input-select" ></select>
						</div>
						<div class="cvv_upgrade" id="cvv_upgrade" style="display: none"><img src="<?php echo $url_update; ?>"></div>
						<div class="cvv_save" id="cvv_save"></div>
						<div class="ccv_err" id="ccv_err"></div>
					</div>
				</div>
			</form><?php
		} ?>
		<?php echo $this->getChildHtml('coupon') ?>
		<div class="cart-totals-wrapper">
			<div class="cart-totals">
				<?php if(!$this->hasError()): ?>
				<ul class="checkout-types bottom">
				<?php foreach ($this->getMethods('methods') as $method): ?>
					<?php if ($methodHtml = $this->getMethodHtml($method)): ?>
					<li class="method-<?php echo preg_replace("/[^_a-zA-Z0-9-]/", '-', $method); ?>"><?php echo $methodHtml; ?></li>
					<?php endif; ?>
				<?php endforeach; ?>
				</ul>
				<?php endif; ?>
			</div>
		</div>
	</div>
</div><?php

?><!-- script_accordion --><script type="text/javascript">
	var acc = document.getElementsByClassName("accordion");
	var i;
	for (i = 0; i < acc.length; i++) {
		acc[i].onclick = function(){
			this.classList.toggle("active");
			var panel = this.nextElementSibling;
			if (panel.style.display === "none") {
				panel.style.display = "block";
			} else {
				panel.style.display = "none";
			}
		}
	}
	<?php foreach($categories as $key => $value ): ?>
		var spans = document.getElementsByClassName("<?php echo str_replace(" ", "", $key) ?>");
		console.log(spans.length);
		for(i = 0; i<spans.length ; i++){
			console.log(i);
			spans[i].textContent = " (<?php echo $categories[$key]["qty"]?>)";
		}
	<?php endforeach;?>
	$$('.grantotal #shopping-cart-totals-table tr')[0].hide();
	$$('.grantotal #shopping-cart-totals-table tr')[1].hide();
	</script><?php 

if( $goo_metricas ){ ?><!-- script_lga 2--><script type="text/javascript">
    var lga = <?php
        /* listado de productos */
        if( $ga_lp==null ){ ?>null<?php }else{
            echo json_encode( $ga_lp );
        }
    ?>;
    document.observe("dom:loaded", function(){ ga_all_checkout(); } );
    function checkout_data(id){
        var a = lga[ id ];

        ga('ec:addProduct', {
            'id': a.sku,
            'name': a.name,
            'category': a.category,
            'brand': a.marca,
            'variant': '',
            'price': a.price,
            'quantity': a.qty
        });
        ga('ec:setAction', 'remove');
        ga('send', 'event', 'UX', 'click', 'remove to cart');

        console.log('ga_remove_item ==> '+a.sku);
        console.log( a );
        return true;
    }
    function ga_all_checkout(evt) {
        for(var k in lga){
            var ld = lga[ k ];

            ga('ec:addProduct', {
              'id': ld.sku,
              'name': ld.name,
              'category': ld.marca,
              'brand': ld.category,
              'variant': '',
              'price': ld.price,
              'quantity': ld.qty
            });

            console.log( ld.sku );
        }

        ga('ec:setAction','checkout', {'step': 2});
        ga('send', 'pageview');     

        console.log('checkout '+lga.length);
        return true;
    }
	</script>
	<?php }else{ ?><script type="text/javascript">
	    var lga = {};
	    function checkout_data(){}
	    function ga_all_checkout(){}
	</script><?php } ?><?php 

if($is_code_vendor){ ?><!-- script_vendor_code --><script type="text/javascript">//<![CDATA[
	var dccv = <?php 
	$ss = 'null';
	if( $cvd != null ){ $ss = json_encode( $cvd ); }
	echo $ss;
	?>;
	var lcv = {};

	document.observe("dom:loaded", function() {
		vendedor_code_list();

		Event.observe( $("cvv_save"),'click', function(){
			$('ccv_err').innerHTML = '';
			if( vendor_code_valid() ){
				vendor_code_save( dccv );
			}
		} );
		Event.observe( $("vendor_code_data_select"),'change', function(){
			vendor_code_save( dccv );
			console.log( dccv['code_vendor'] );
		} );
		if( $("button_checkout_ini") != null ){
			Event.observe( $("button_checkout_ini"),'click', function(event){
				event.preventDefault();
				if( dccv['code_vendor'] != '' ){
					vendor_code_save( dccv );
				}
				console.log( dccv['code_vendor'] );
			} );
		}
	});
    function vendor_code_valid(){
        var d = $('vendor_code_data').value;
        d = d.trim();
        if( d != '' ){
            dccv['code_vendor'] = d;
            return true;
        }

        $('ccv_err').innerHTML = 'Teclee un c&oacute;digo de vendedor.';
        return false;
    }
	function vendor_code_save(d){
		$('ccv_err').innerHTML = '...';
		dccv['code_vendor'] = $("vendor_code_data_select").value;
		if( dccv['code_vendor'] == "0" ){
			$('ccv_err').innerHTML = '';
			return false;
		}

		$('cvv_upgrade').show();
		d['system'] = 'code_vendor_save';
		d['mkd'] = "<?php echo $_SESSION['core']['visitor_data']['session_id']; ?>";
		new Ajax.Request('<?php 
			echo Mage::getBaseUrl();
			?>NESCA/ajx.code_vendor.php',
		{
			method: 'POST'
			, parameters: d
			, onFailure: function(transport) {
				console.log('error to send vendor code');
			}
			, onSuccess: function(transport) {
				var res = transport.responseText.evalJSON();
				if( res['status']=='ok' ){
					$('ccv_err').innerHTML = 'Datos guardados';
				}else{
					$('ccv_err').innerHTML = res['message'];
				}
			}
		} );
		$('cvv_upgrade').hide();
	}
	function vendedor_code_list(){
		var url = "<?php echo Mage::getBaseUrl()."NESCA/ajx.code_vendor_list.php"; ?>";
		new Ajax.Request( url,
		{
			method: 'POST'
			, parameters: { "mkd":"<?php echo $_SESSION['core']['visitor_data']['session_id']; ?>" }
			, onFailure: function(transport) {
				console.log('error to send vendor code');
			}
			, onSuccess: function(transport) {
				var res = transport.responseText.evalJSON();
				if( res['status']=='ok' ){
					if( res['n']>0 ){
						vendedor_code_add_select( res['data'], res['us'] );
						if( res['us'] != null ){
							dccv['code_vendor'] = res['us'];
						}
					}
				}else{
					console.log( 'error al cargar el listado de los vendedores' );
				}
			}
		} );
	}
	function vendedor_code_add_select(v,u){
		var opt = document.createElement('option');
		opt.text = 'Selecciona un código de vendedor';
		opt.value = 0;
		$('vendor_code_data_select').options.add(opt);


		$('vendor_code_data').hide();
		$('cvv_save').hide();

		for( var k in v ){
			var opt = document.createElement('option');
			//opt.text = v[k]['name']+' '+v[k]['code'];
			var tt = v[k]['name'];
			tt = tt.replace( /\./g , "&nbsp;" );
			//console.log( '['+tt+']' );

			opt.innerHTML = tt+' '+v[k]['code'];
			opt.value = v[k]['code'];
			if( u == v[k]['code'] ){
				opt.selected = true;
			}
			$('vendor_code_data_select').options.add(opt);
			//$('#vendor_code_data_select').append("<Option value="+v[k]['code']+" >"+v[k]['name']+' '+v[k]['code']+"</Option>");
		}

		$('ccv_select').show();

		return true;
	}
	//]]></script><?php } ?>
