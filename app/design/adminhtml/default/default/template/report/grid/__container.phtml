<?php
/**
 * Magento Enterprise Edition
 *
 * NOTICE OF LICENSE
 *
 * This source file is subject to the Magento Enterprise Edition End User License Agreement
 * that is bundled with this package in the file LICENSE_EE.txt.
 * It is also available through the world-wide-web at this URL:
 * http://www.magento.com/license/enterprise-edition
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to license@magento.com so we can send you a copy immediately.
 *
 * DISCLAIMER
 *
 * Do not edit or add to this file if you wish to upgrade Magento to newer
 * versions in the future. If you wish to customize Magento for your
 * needs please refer to http://www.magento.com for more information.
 *
 * @category    design
 * @package     default_default
 * @copyright Copyright (c) 2006-2017 X.commerce, Inc. and affiliates (http://www.magento.com)
 * @license http://www.magento.com/license/enterprise-edition
 */
?><?php
/**
 * rmorales@mlg.com.mx
 * determina tipo de usuario
 *
 */

$user_attrib = true;
    $customer = Mage::getSingleton('Admin/session')->getUser();
    $role = $customer->getRole()->getData();
    $show_report_shipping = false;


?><?php
/**
 * rmorales@mlg.com.mx
 * report sales custom
 *
 */

$rs_custom = true;
$modif = 'adminhtml/report_sales_sales';
$script = false;

$_portal = $_SERVER['REQUEST_SCHEME'].'://'.$_SERVER['HTTP_HOST']; // https://midominio.com
//$_portal = $this->getUrl('');

?>
<div class="content-header">
    <table cellspacing="0">
        <tr>
            <td style="<?php echo $this->getHeaderWidth() ?>"><?php echo $this->getHeaderHtml() ?></td>
            <?php

            if( $rs_custom ){
                if( isset( $this->_data['type'] ) ){
                    if( $this->_data['type'] == $modif ){
                        ?><td class="form-buttons"><?php
                            ?><div id="report_sales"><?php
                                ?><button id="report_sales_order" type="button">Descargar Reporte de Ventas</button><?php
                                ?><iframe id="download_file_ca" style="display:none;"></iframe><?php
                            ?></div><?php

                            if( isset( $role['role_id'] ) ){
                                if( $role['role_id'] == 1 ){
                                    $show_report_shipping = true;
                                }
                            }

                            ?><div id="report_shipping" <?php if( !$show_report_shipping ){ echo "style=\"display:none;\""; } ?> ><?php
                                ?><button id="report_shipping_order" type="button">Descargar Reporte de Envios</button><?php
                                ?><iframe id="download_file_cs" style="display:none;"></iframe><?php
                            ?></div><?php
                        ?></td><?php
                    }else{
                        $rs_custom = false;
                        ?><td class="form-buttons"><?php echo $this->getButtonsHtml() ?></td><?php
                    }
                }else{
                    $rs_custom = false;
                }
            }else{
                ?><td class="form-buttons"><?php echo $this->getButtonsHtml() ?></td><?php
            }

            ?>
        </tr>
    </table>
</div>
<div <?php if( $rs_custom ){ echo 'style="display:none;"'; } ?> ><?php echo $this->getChildHtml('store.switcher') ?></div>
<div <?php if( $rs_custom ){ echo 'style="display:none;"'; } ?> ><?php echo $this->getChildHtml('grid.filter.form') ?></div>
<div <?php if( $rs_custom ){ echo 'style="display:none;"'; } ?> ><?php echo $this->getGridHtml() ?></div><?php
if( $rs_custom ){
    ?><div id="error_report"></div><?php
} ?>

<script type="text/javascript">
//<![CDATA[
    function filterFormSubmit() {
        var filters = $$('#filter_form input', '#filter_form select');
        var elements = [];
        for(var i in filters){
            if(filters[i].value && filters[i].value.length && !filters[i].disabled) elements.push(filters[i]);
        }
        var validator  = new Validation('filter_form');
        if (validator.validate()) {
            setLocation('<?php echo $this->getFilterUrl(); ?>filter/'+encode_base64(Form.serializeElements(elements))+'/');
        }
    }
//]]>
</script>

<?php

if( $rs_custom ){
    ?><script type="text/javascript">
//<![CDATA[
    var cadowm = document.getElementById('report_sales_order');
    cadowm.addEventListener('click', function () { download('ca'); });

    var csdowm = document.getElementById('report_shipping_order');
    csdowm.addEventListener('click', function () { download('cs'); });

    var file_ca = null;
    var file_ca_down = 0;

    document.observe("dom:loaded", function() {
        last_report_ca();
    } );

    function last_report_ca(){
        var url = "<?php echo $_portal ?>/NESCA/ajx.report_rsales.php";
        //console.log( "url reports ==> "+url );
        new Ajax.Request( url,
            {
                method: 'POST'
                , parameters: { "mkd":"s820b7sjhjsfejkloo9399qqr7" }
                , onFailure: function(transport) {
                    console.log('error conexion');
                }
                , onSuccess: function(transport) {
                    var res = transport.responseText.evalJSON();
                    file_ca = res;
                }
            } );
    }

    function download( tipo ){
        console.log('inicia descarga ==> '+tipo);

        file_ca_down = file_ca_down + 1;

        if( file_ca == null ){
            $('error_report').innerHTML = file_ca_down + ' reporte no accesible contacte con su administrador';
            return null;
        }

        var doc = 'download_file_'+tipo;
        console.log( "download "+doc );
        var iframe = document.getElementById( doc );
        var fl = "<?php echo $_portal; ?>/NESCA/mlg_reports/";

        if( tipo == 'ca' ){ fl = fl+file_ca['f']; }
        if( tipo == 'cs' ){ fl = fl+file_ca['sh']; }

        console.log( fl );

        iframe.src = fl;

        return true;
    }
//]]>
</script><?php } ?>